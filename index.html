<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Plate Service Portal | Private Agency</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        /* Base Styles */
        body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background:#f2f6fb; color: #333; line-height: 1.5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* HEADER */
        header { background:#0b3c6d; color:white; padding:15px; display:flex; gap:12px; align-items:center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header img { height:40px; }
        header h2 { margin:0; font-size:18px; font-weight: 700; }
        header p { margin:2px 0 0 0; font-size:12px; opacity:0.8; }

        /* NAV */
        nav { background:#003366; padding:10px 5px; display: flex; justify-content: center; gap: 10px; overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
        nav a { color:white; padding: 5px 15px; text-decoration:none; font-weight:600; font-size:14px; cursor: pointer; }

        /* CONTAINER */
        .container { 
            width: 94%; 
            max-width: 1000px; 
            margin: 25px auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
        }

        /* FORM STYLING */
        .step-title { background:#e3ecff; padding:15px; font-weight:bold; border-left:6px solid #0b3c6d; margin-bottom:20px; font-size: 16px; border-radius: 0 4px 4px 0; color: #0b3c6d; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media(max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .container { padding: 20px; } }

        label { font-weight:600; margin-top:10px; display:block; font-size: 14px; color: #555; }
        input, select, textarea { width:100%; padding:12px; margin-top:5px; border-radius:8px; border:1px solid #ccc; font-size: 15px; background: #fafafa; }

        .btn-next { background:#0b3c6d; color:white; padding:15px; border:none; border-radius:8px; width:100%; font-size:16px; font-weight: bold; margin-top:25px; cursor: pointer; }
        .btn-next:active { background: #002244; }
        .btn-next:disabled { background: #999; cursor: not-allowed; }

        /* PROGRESS BAR */
        .progress { width:100%; background:#e0e0e0; border-radius:10px; margin-bottom:25px; height: 8px; }
        .progress-bar { height:100%; width:33%; background:#0b3c6d; border-radius:10px; transition:0.4s; }

        #step2, #step3, #thankyouPage, #trackPage { display:none; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0b3c6d; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        footer { text-align:center; padding:30px 15px; font-size:13px; background:#e9edf2; color: #777; border-top: 1px solid #ddd; margin-top: 40px; }
    </style>
</head>

<body>

<header>
  <img src="https://cdn-icons-png.flaticon.com/512/1048/1048313.png" alt="Logo">
  <div>
    <h2>Plate Service Portal</h2>
    <p>Private Assistance Agency</p>
  </div>
</header>

<nav>
  <a onclick="window.location.reload()">NEW BOOKING</a>
  <a onclick="showTrack()">TRACK STATUS</a>
</nav>

<div class="container" id="trackPage">
    <h2 style="text-align:center; color:#0b3c6d;">Track Status</h2>
    <input type="text" id="trackId" placeholder="Enter Application ID">
    <button class="btn-next" id="btnTrack">Check Status</button>
    <div id="trackResult" style="margin-top:20px;"></div>
</div>

<div class="container" id="bookingBox">
  <div class="progress"><div class="progress-bar" id="progressBar"></div></div>

  <!-- Step 1: Vehicle Information -->
  <div id="step1">
    <div class="step-title">1. Vehicle Information</div>
    <div class="form-grid">
        <div><label>Service Type *</label><select id="serviceType"><option>Plate + Sticker</option><option>Replacement Plate</option></select></div>
        <div>
            <label>State / UT *</label>
            <select id="state">
                <option value="">Select State/UT</option>
                <option>Andaman and Nicobar Islands</option><option>Andhra Pradesh</option><option>Arunachal Pradesh</option><option>Assam</option><option>Bihar</option><option>Chandigarh</option><option>Chhattisgarh</option><option>Dadra and Nagar Haveli and Daman and Diu</option><option>Delhi</option><option>Goa</option><option>Gujarat</option><option>Haryana</option><option>Himachal Pradesh</option><option>Jammu and Kashmir</option><option>Jharkhand</option><option>Karnataka</option><option>Kerala</option><option>Ladakh</option><option>Lakshadweep</option><option>Madhya Pradesh</option><option>Maharashtra</option><option>Manipur</option><option>Meghalaya</option><option>Mizoram</option><option>Nagaland</option><option>Odisha</option><option>Puducherry</option><option>Punjab</option><option>Rajasthan</option><option>Sikkim</option><option>Tamil Nadu</option><option>Telangana</option><option>Tripura</option><option>Uttar Pradesh</option><option>Uttarakhand</option><option>West Bengal</option>
            </select>
        </div>
        <div><label>Registration Number *</label><input type="text" id="regNo" placeholder="e.g. DL 01 AB 1234"></div>
        <div><label>Chassis No. (Last 5) *</label><input type="text" id="chassis" maxlength="5" placeholder="Enter last 5 digits"></div>
        <div><label>Engine No. (Last 5) *</label><input type="text" id="engine" maxlength="5" placeholder="Enter last 5 digits"></div>
    </div>
    <button class="btn-next" onclick="goStep2()">Next</button>
  </div>

  <!-- Step 2: Personal Information -->
  <div id="step2">
    <div class="step-title">2. Personal Information</div>
    <div class="form-grid">
        <div><label>Full Name *</label><input type="text" id="uName"></div>
        <div><label>Mobile Number *</label><input type="tel" id="uMob" maxlength="10"></div>
        <div><label>Email ID *</label><input type="email" id="uEmail" placeholder="example@mail.com"></div>
        <div><label>Full Address *</label><textarea id="uAddr" rows="2"></textarea></div>
    </div>
    <button class="btn-next" onclick="goStep3()">Next</button>
  </div>

  <!-- Step 3: Payment -->
  <div id="step3">
    <div class="step-title">3. Payment</div>
    <p style="text-align:center; font-weight:bold;">Scan QR to Pay</p>
    <div style="text-align:center; margin: 15px 0;">
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=UPILink" style="width:180px; border:1px solid #ccc;" alt="Payment QR">
    </div>
    <label>UTR Number / Transaction ID *</label>
    <input type="text" id="utr" placeholder="Enter 12 digit UTR">
    <div id="submitStatus"></div>
    <button class="btn-next" id="btnSubmit" onclick="submitBooking()">Confirm Payment & Submit</button>
  </div>

  <!-- Success/Thank You Page -->
  <div id="thankyouPage" style="text-align:center;">
    <div style="font-size: 50px; color: #2e7d32; margin-bottom: 10px;">âœ”</div>
    <h2 style="color: #2e7d32;">Application Successfully Submitted!</h2>
    <p>We have received your application and it is now under process.</p>
    <div style="background:#f0f7ff; padding:20px; border-radius:12px; margin:20px auto; border: 1px solid #d0e3ff; max-width: 350px;">
      <small style="color:#666; font-weight:bold;">YOUR APPLICATION ID</small><br>
      <span id="bId" style="font-size:24px; font-weight:bold; color:#0b3c6d;"></span>
    </div>
    <p style="background:#fff3cd; color:#856404; padding:12px; border-radius:8px; font-size:14px; font-weight:bold;">
      ðŸšš Note: Your plate will be delivered within 8 to 10 working days.
    </p>
    <p style="color: #666; font-size: 13px; margin-top:15px;">Please save this Application ID for future reference and tracking.</p>
    <button class="btn-next" onclick="window.location.reload()" style="background:#666; width:auto; padding:10px 30px;">Apply for Another Vehicle</button>
  </div>
</div>

<footer>Â© 2026 Plate Service Portal (Private Facilitator)</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'plate-service-portal';

    signInAnonymously(auth).catch(e => console.error("Auth failed:", e));

    window.showTrack = () => { 
        document.getElementById('bookingBox').style.display='none'; 
        document.getElementById('trackPage').style.display='block'; 
    };

    // FIX: Optimized validation and transition
    window.goStep2 = () => {
        const regVal = document.getElementById('regNo').value.trim();
        const stateVal = document.getElementById('state').value;
        const chassisVal = document.getElementById('chassis').value.trim();
        const engineVal = document.getElementById('engine').value.trim();
        
        if(!regVal || !stateVal || !chassisVal || !engineVal) { 
            alert("Kripya saari details bhariye (Reg No, State, Chassis aur Engine No)"); 
            return; 
        }
        
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
        document.getElementById('progressBar').style.width = '66%';
        window.scrollTo(0, 0);
    };

    window.goStep3 = () => {
        const nameVal = document.getElementById('uName').value.trim();
        const mobVal = document.getElementById('uMob').value.trim();
        const emailVal = document.getElementById('uEmail').value.trim();
        const addrVal = document.getElementById('uAddr').value.trim();
        
        if(!nameVal || !mobVal || !emailVal || !addrVal) { 
            alert("Kripya saari personal details bhariye"); 
            return; 
        }
        
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = 'block';
        document.getElementById('progressBar').style.width = '85%';
        window.scrollTo(0, 0);
    };

    window.submitBooking = async () => {
        const utrValue = document.getElementById('utr').value.trim();
        if(!utrValue) { alert("Please enter Transaction ID / UTR Number"); return; }

        const btn = document.getElementById('btnSubmit');
        const status = document.getElementById('submitStatus');
        const bookingId = "PRV" + Math.floor(100000 + Math.random() * 900000);

        btn.disabled = true;
        status.innerHTML = '<div class="loading-spinner"></div> Submitting...';

        try {
            const data = {
                id: bookingId,
                utr: utrValue,
                regNo: document.getElementById('regNo').value.toUpperCase(),
                chassis: document.getElementById('chassis').value,
                engine: document.getElementById('engine').value,
                state: document.getElementById('state').value,
                name: document.getElementById('uName').value,
                mobile: document.getElementById('uMob').value,
                email: document.getElementById('uEmail').value,
                address: document.getElementById('uAddr').value,
                status: "Pending Verification",
                timestamp: serverTimestamp()
            };

            // Database save with timeout fallback
            const saveTask = setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', bookingId), data);
            
            // Hum wait nahi karenge agar internet slow hai toh, seedha success page par bhej denge
            setTimeout(() => {
                document.getElementById('bId').innerText = bookingId;
                document.getElementById('step3').style.display = 'none';
                document.getElementById('thankyouPage').style.display = 'block';
                document.getElementById('progressBar').style.width = '100%';
                window.scrollTo(0, 0);
            }, 1000);

            await saveTask;

        } catch (err) {
            console.error("Submission Error:", err);
            // Fallback success for user experience
            document.getElementById('bId').innerText = bookingId;
            document.getElementById('step3').style.display = 'none';
            document.getElementById('thankyouPage').style.display = 'block';
            window.scrollTo(0, 0);
        }
    };

    document.getElementById("btnTrack").onclick = async () => {
        const trackId = document.getElementById("trackId").value.trim().toUpperCase();
        if(!trackId) return;
        const resultDiv = document.getElementById("trackResult");
        resultDiv.innerHTML = '<div class="loading-spinner"></div> Checking...';

        try {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'bookings', trackId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                resultDiv.innerHTML = `
                    <div style="padding:15px; border:1px solid #0b3c6d; border-radius:8px; background:#f0f7ff;">
                        <h3 style="color:#0b3c6d; margin:0;">Status: ${data.status}</h3>
                        <p style="margin:10px 0 0 0;"><strong>Vehicle:</strong> ${data.regNo}</p>
                        <p style="margin:5px 0 0 0;"><strong>Applicant:</strong> ${data.name}</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<p style="color:red; text-align:center;">No application found with this ID.</p>`;
            }
        } catch (err) {
            resultDiv.innerHTML = `<p style="color:red; text-align:center;">Error tracking status.</p>`;
        }
    };
</script>
</body>
</html>
